# セットアップガイド

Stream Deck設定の構築とデプロイの完全な手順書です。

## 前提条件

- [ ] **Bitfocus Companion** v4.2以上がインストール済み ([ダウンロード](https://bitfocus.io/companion))
- [ ] **Stream Deck XL** がUSBで接続済み (8x4 = 32ボタン)
- [ ] すべてのAV機器へのネットワークアクセス (またはプレースホルダーIP)
- [ ] このリポジトリがビルドマシンにクローン/ダウンロード済み

## フェーズ1: Companionのインストール

1. [bitfocus.io/companion](https://bitfocus.io/companion) からCompanionをダウンロード
2. お使いのOS (macOS, Windows, Linux) 用にインストール
3. Companionを起動
4. ウェブブラウザで `http://localhost:8000` を開く
5. CompanionダッシュボードのWeb UIが表示されることを確認

## フェーズ2: サーフェスの設定

1. Stream Deck XLをUSBで接続
2. Companionの **Surfaces** タブに移動
3. Stream Deck XLが表示されていることを確認 ("Elgato Stream Deck XL - 32 keys")
4. サーフェス名を `Church-Main` に設定 (任意)
5. グリッドが8列 x 4行であることを確認

## フェーズ3: 接続の追加

`config/connections.yaml` に従って各モジュール接続を追加します。

詳細な手順は `docs/COMPANION-UI-WALKTHROUGH.md` を参照してください。

**接続一覧:**

| # | モジュール | ラベル | IP | ポート |
|---|-----------|--------|-----|--------|
| 1 | `renewedvision-propresenter` | ProPresenter | IP-CONFIGURATION.md参照 | 20404 |
| 2 | `obs-studio` | OBS Studio | IP-CONFIGURATION.md参照 | 4455 |
| 3 | `bmd-atem` | ATEM Switcher | IP-CONFIGURATION.md参照 | 9910 |
| 4 | `yamaha-rcp` | Yamaha TF1 | IP-CONFIGURATION.md参照 | 49280 |
| 5 | `generic-pingandwake` | Wake-on-LAN | 対象PCのIP | N/A |
| 6 | `generic-ssh` | SSH Remote Control | 対象PCのIP | 22 |

接続7-8 (ディスプレイ、スマートコンセント) は機器確認後に決定します。

## フェーズ4: ページの作成

10ページそれぞれについて、対応するYAMLファイルを開き、指定されたすべてのボタンを作成します。

**推奨作成順序:**
1. ページ1 (ホーム) — 役割選択とステータスレイアウトの基盤
2. ページ10 (緊急) — 下部行の安全ボタンが参照する先
3. ページ2 (スライド基本) — 最もよく使用される役割ページ
4. ページ4, 6, 8 (他の基本役割ページ)
5. ページ3, 5, 7, 9 (拡張役割ページ)

ボタン作成の詳細手順は `docs/COMPANION-UI-WALKTHROUGH.md` を参照してください。

### ページファイル一覧:

| ページ | YAMLファイル |
|--------|-------------|
| 1 | `config/pages/page01-home.yaml` |
| 2 | `config/pages/page02-slides-core.yaml` |
| 3 | `config/pages/page03-slides-extended.yaml` |
| 4 | `config/pages/page04-audio-core.yaml` |
| 5 | `config/pages/page05-audio-extended.yaml` |
| 6 | `config/pages/page06-camera-core.yaml` |
| 7 | `config/pages/page07-camera-extended.yaml` |
| 8 | `config/pages/page08-stream-core.yaml` |
| 9 | `config/pages/page09-stream-extended.yaml` |
| 10 | `config/pages/page10-emergency.yaml` |

## フェーズ5: テスト

`docs/TESTING-CHECKLIST.md` を使用して以下を確認:
- すべてのページが正しい名前で存在する
- ナビゲーションボタンがすべてのページ間で動作する
- 接続ステータスインジケーターが正しい色で表示される
- アクションが正しくトリガーされる (実機が必要)
- 下部行がすべてのページで統一されている

実機なしでテストする場合:
- すべてのボタンのテキストと色が正しい
- ページ間のナビゲーションが動作する
- ボタンがグリッド上の正しい位置にある

## フェーズ6: エクスポート

1. Companionの **Import/Export** タブに移動
2. **Export** をクリック
3. **Compressed (.companionconfig)** 形式を選択
4. `church-japan-YYYY-MM.companionconfig` として保存
5. バックアップコピーを作成

## フェーズ7: 教会へのデプロイ

1. 教会のPCにCompanionをインストール
2. Stream Deck XLをUSBで接続
3. `.companionconfig` ファイルをインポート:
   - **Import/Export** タブに移動
   - **Import** をクリック
   - エクスポートしたファイルを選択
   - **Full Import** を選択 (既存の設定をすべて置き換え)
4. **IPアドレスの更新**:
   - **Connections** タブに移動
   - 各接続のIPアドレスを実際のデバイスIPに更新
   - `docs/IP-CONFIGURATION.md` のアドレス表を参照
5. **ヘルパースクリプトの更新**:
   - `scripts/network-test.sh` と `scripts/port-check.sh` のIPアドレスを編集
   - または環境変数を設定 (スクリプトヘッダーの詳細を参照)
6. **サービス前チェックの実行**:
   ```bash
   chmod +x scripts/*.sh
   ./scripts/pre-service-check.sh
   ```
7. 実際の機器で各役割のページをテスト
8. ライブ接続で `docs/TESTING-CHECKLIST.md` を再度実行

## フェーズ8: ボランティアのトレーニング

1. 各ボランティアに担当の役割ページ (各役割2ページ) を説明
2. 下部行の規則を実演 (左側=ナビゲーション、右側=安全)
3. MUTE ALL (全ミュート) と BLACK (ブラック) の緊急ボタンを練習
4. 各ボランティアに `docs/OPERATOR-QUICK-REFERENCE.md` のコピーを配布
5. 全役割を配置したフルサービスリハーサルを実施

## 継続的なメンテナンス

- **各サービスの前**: `scripts/pre-service-check.sh` を実行
- **変更後**: 新しい `.companionconfig` バックアップをエクスポート
- **未解決事項の解決時**: YAMLスペック、`open-questions.md` を更新し、影響するボタンを再構築
- **バージョン管理**: 変更内容のメモとともにこのリポジトリにコミット

## 色の規則

| 色 | 意味 | 用途 |
|----|------|------|
| 赤 (#CC0000) | 危険・停止 | ミュート、停止、切断、ライブ表示 |
| 緑 (#00CC00) | 進行・有効 | 開始、接続済み、プレビュー |
| 青 (#0066CC) | ナビゲーション | ページ間移動 |
| 黄 (#CCCC00) | 注意・待機 | 確認待ち、スタンバイ |
| 灰 (#666666) | 無効・非アクティブ | 使用不可のボタン |

## ボタンの配置規則

Stream Deck XL: 8列 x 4行 = 32ボタン

```
行0: [機能ボタン ...]
行1: [メインコントロール ...]
行2: [追加コントロール / ステータス ...]
行3: [ホーム] [◀前] [次▶] [---] [---] [---] [全ミュート] [ブラック]
```

**下部行 (行3) はすべてのページで統一:**
- `[3,0]` ホーム — ホームページに戻る (青)
- `[3,1]` 前のページ — 同じ役割の前のページ (青/灰)
- `[3,2]` 次のページ — 同じ役割の次のページ (青/灰)
- `[3,6]` 全ミュート — TF1のマスター出力をミュート (赤)
- `[3,7]` ブラック — ATEMの出力をブラックに切替 (赤)
